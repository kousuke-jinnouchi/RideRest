<div class="container my-4">
  <div class="card shadow-sm border-0">
    <div class="row g-0">
      <div class="col-md-6">
        <%= image_tag @parking_lot.get_image, class: 'img-fluid rounded-start w-100', style: 'object-fit: cover; height: 100%; min-height: 350px;' %>
      </div>
      <div class="col-md-6 d-flex flex-column">
        <div class="card-body">
          <h2 class="card-title h3 mb-1"><%= @parking_lot.parking_lot_name %></h2>
          <% if @parking_lot.tag_list.present? %>
            <div class="mb-3">
              <% @parking_lot.tag_list.each do |tag| %>
                <%= link_to parking_lots_path(tag: tag), class: "btn btn-sm btn-outline-info me-2 mb-2" do %>
                  <i class="fas fa-tag mr-1"></i><%= tag %>
                <% end %>
              <% end %>
            </div>
          <% end %>
          <p class="card-subtitle mb-3 text-muted">
            <i class="fas fa-map-marker-alt"></i> 
            <%= @parking_lot.address %>
          </p>
          <p class="card-text bg-light p-3 rounded"><%= @parking_lot.description %></p>
          <div class="d-flex justify-content-between align-items-center p-3 my-3 bg-white rounded shadow-sm border-left border-success" style="border-width: 4px !important;">
            <span class="h5 mb-0 text-dark">料金</span>
            <span class="h4 mb-0 text-success font-weight-bold"><%= @parking_lot.fee %></span>
          </div>
          <% if @parking_lot.user == current_user %>
            <div class="d-flex">
              <%= link_to "この投稿を編集する", edit_parking_lot_path(@parking_lot), class: 'btn btn-outline-info mr-2' %>
              <%= link_to "この投稿を削除する", parking_lot_path(@parking_lot), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'btn btn-outline-danger' %>
            </div>
          <% end %>
        </div>

        <div class="card-footer bg-transparent border-top-0 mt-auto">
          <div class="d-flex align-items-center">
            <%= image_tag @parking_lot.user.get_profile_image(100, 100), class: 'rounded-circle me-3', width: 45, height: 45 %>
            <div>
              <div class="text-muted small">投稿者: <%= @parking_lot.user.name %></div>
              <div class="text-muted small">投稿日: <%= @parking_lot.created_at.strftime('%Y/%m/%d') %></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
  <div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow-sm mb-5">
        <div class="card-header bg-light">
          <h4 class="mb-0">レビューを投稿する</h4>
        </div>
        <div class="card-body">
          <%= form_with model: [@parking_lot, @comment], url: parking_lot_comments_path(@parking_lot) do |f| %>
            <div class="form-group row align-items-center">
              <label class="col-md-3 col-form-label text-md-right font-weight-bold">総合評価</label>
              <div class="col-md-9">
                <div id="star-rating-form"></div>
              </div>
            </div>
            <div class="form-group">
              <%= f.label :body, "レビュー", class: "font-weight-bold" %>
              <%= f.text_area :body, rows: 5, class: 'form-control', placeholder: "この駐輪場の良かった点、気になった点などを自由にお書きください。" %>
            </div>
            <div class="text-right">
              <%= f.submit "投稿する", class: 'btn btn-primary btn-lg' %>
            </div>
          <% end %>
        </div>
      </div>
      <div>
        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-4">
          <h4 class="mb-0">
            レビュー (<%= @parking_lot.comments.count %>件)
          </h4>
        </div>
        <% if @parking_lot.comments.any? %>
          <% @parking_lot.comments.each do |comment| %>
            <div class="media mb-4">
              <%= image_tag comment.user.get_profile_image(100,100), class: 'mr-3 rounded-circle', style: 'width: 64px; height: 64px;' %>
              <div class="media-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h5 class="mt-0 font-weight-bold"><%= comment.user.name %></h5>
                    <div class="review-star" data-score="<%= comment.score %>"></div>
                  </div>
                  <small class="text-muted"><%= comment.created_at.strftime('%Y/%m/%d') %></small>
                </div>
                <p class="mt-2 mb-1"><%= simple_format(h(comment.body)) %></p>
                <% if comment.user == current_user %>
                  <div class="text-right">
                    <%= link_to '削除', parking_lot_comment_path(comment.parking_lot, comment), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'btn btn-outline-danger btn-sm' %>
                  </div>
                <% end %>
              </div>
            </div>
            <hr class="my-4">
          <% end %>
        <% else %>
          <div class="text-center p-5 bg-light rounded">
            <p class="h5 text-muted">まだレビューはありません。</p>
            <p class="text-muted">この駐輪場の最初のレビューを投稿してみませんか？</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('turbolinks:load', function() {
    let starForm = document.querySelector('#star-rating-form');
    if (starForm) {
      if (starForm.innerHTML.trim() !== "") {
        let ratyInstance = Raty.getInstance(starForm);
        if(ratyInstance) {
          ratyInstance.destroy();
        }
      }
      raty(starForm, {
        size:      36,
        starOff:  '<%= asset_path('star-off.png') %>', 
        starOn :  '<%= asset_path('star-on.png') %>',  
        starHalf: '<%= asset_path('star-half.png') %>',
        scoreName: 'comment[score]', 
        half:      true,
      });
    }

    let reviewStars = document.querySelectorAll('.review-star');
    reviewStars.forEach(function(starElem) {
      if (starElem.innerHTML.trim() !== "") {
        let ratyInstance = Raty.getInstance(starElem);
        if(ratyInstance) {
          ratyInstance.destroy();
        }
      }
      raty(starElem, {
        starOff:  '<%= asset_path('star-off.png') %>',
        starOn :  '<%= asset_path('star-on.png') %>',
        starHalf: '<%= asset_path('star-half.png') %>',
        half:     true,
        readOnly: true, 
        score:    starElem.dataset.score, 
      });
    });
  });
</script>
